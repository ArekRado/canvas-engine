<html>
  <head>
    <style>
      html {
        background-color: black;
      }
      canvas {
        width: 600px;
        height: 600px;
        border: 1px solid blue;
      }
    </style>
  </head>

  <body>
    <canvas id="demo" width="600" height="600"></canvas>

    <script>
      const canvasSize = [600, 600]
      const canvas = document.getElementById('demo')
      const ctx = canvas.getContext('2d')

      const getAABBCollision = ({
        rectangle1: [r1x1, r1y1, r1x2, r1y2],
        rectangle2: [r2x1, r2y1, r2x2, r2y2],
      }) => r1x1 <= r2x2 && r1x2 >= r2x1 && r1y1 <= r2y2 && r1y2 >= r2y1

      const emptyQuadTree = {
        topRight: null,
        topLeft: null,
        bottomRight: null,
        bottomLeft: null,
        data: [],
      }

      const flatQuadTree = (tree, maxLevel) => {
        const a = []
        if (tree.topRight) {
          const data = flatQuadTree(tree.topRight, maxLevel - 1)
          if (maxLevel === 1 && data.length > 1) {
            a.push(data)
          } else if (data[0]?.length > 1) {
            a.push(...data)
          }
        }
        if (tree.topLeft) {
          const data = flatQuadTree(tree.topLeft, maxLevel - 1)
          if (maxLevel === 1 && data.length > 1) {
            a.push(data)
          } else if (data[0]?.length > 1) {
            a.push(...data)
          }
        }
        if (tree.bottomRight) {
          const data = flatQuadTree(tree.bottomRight, maxLevel - 1)
          if (maxLevel === 1 && data.length > 1) {
            a.push(data)
          } else if (data[0]?.length > 1) {
            a.push(...data)
          }
        }
        if (tree.bottomLeft) {
          const data = flatQuadTree(tree.bottomLeft, maxLevel - 1)
          if (maxLevel === 1 && data.length > 1) {
            a.push(data)
          } else if (data[0]?.length > 1) {
            a.push(...data)
          }
        }

        return a.concat(tree.data)
      }
      const splitBounds = ({ bounds, position }) => {
        const boundHalfWidth = (bounds[2] - bounds[0]) / 2
        const boundHalfHeight = (bounds[3] - bounds[1]) / 2
        switch (position) {
          case 'topRight':
            return [
              bounds[0] + boundHalfWidth,
              bounds[1] + boundHalfHeight,
              bounds[2],
              bounds[3],
            ]
          case 'topLeft':
            return [
              bounds[0],
              bounds[1] + boundHalfHeight,
              bounds[2] - boundHalfWidth,
              bounds[3],
            ]
          case 'bottomRight':
            return [
              bounds[0] + boundHalfWidth,
              bounds[1],
              bounds[2],
              bounds[3] - boundHalfHeight,
            ]
          case 'bottomLeft':
            return [
              bounds[0],
              bounds[1],
              bounds[2] - boundHalfWidth,
              bounds[3] - boundHalfHeight,
            ]
        }
      }
      const getQuadTree = ({
        bounds,
        rectangles,
        maxLevel = 1,
        treeNode = emptyQuadTree,
      }) => {
        const isNodeEmpty =
          (treeNode.topRight === null &&
            treeNode.topLeft === null &&
            treeNode.bottomRight === null &&
            treeNode.bottomLeft === null) ||
          (treeNode.topRight?.data.length === 0 &&
            treeNode.topLeft?.data.length === 0 &&
            treeNode.bottomRight?.data.length === 0 &&
            treeNode.bottomLeft?.data.length === 0)

        if (maxLevel === 0 || (rectangles.length <= 1 && isNodeEmpty)) {
          return {
            topRight: treeNode.topRight,
            topLeft: treeNode.topLeft,
            bottomRight: treeNode.bottomRight,
            bottomLeft: treeNode.bottomLeft,
            data: rectangles,
          }
        } else {
          const newTree = rectangles.reduce((acc, data) => {
            const splittedBounds = {
              topRight: splitBounds({ bounds, position: 'topRight' }),
              topLeft: splitBounds({ bounds, position: 'topLeft' }),
              bottomRight: splitBounds({ bounds, position: 'bottomRight' }),
              bottomLeft: splitBounds({ bounds, position: 'bottomLeft' }),
            }

            const topRight = getAABBCollision({
              rectangle1: data.rectangle,
              rectangle2: splittedBounds.topRight,
            })
              ? getQuadTree({
                  bounds: splittedBounds.topRight,
                  rectangles: acc.topRight?.data.concat(data) ?? [data],
                  treeNode: acc.topRight ?? emptyQuadTree,
                  maxLevel: maxLevel - 1,
                })
              : acc.topRight

            const topLeft = getAABBCollision({
              rectangle1: data.rectangle,
              rectangle2: splittedBounds.topLeft,
            })
              ? getQuadTree({
                  bounds: splittedBounds.topLeft,
                  rectangles: acc.topLeft?.data.concat(data) ?? [data],
                  treeNode: acc.topLeft ?? emptyQuadTree,
                  maxLevel: maxLevel - 1,
                })
              : acc.topLeft

            const bottomRight = getAABBCollision({
              rectangle1: data.rectangle,
              rectangle2: splittedBounds.bottomRight,
            })
              ? getQuadTree({
                  bounds: splittedBounds.bottomRight,
                  rectangles: acc.bottomRight?.data.concat(data) ?? [data],
                  treeNode: acc.bottomRight ?? emptyQuadTree,
                  maxLevel: maxLevel - 1,
                })
              : acc.bottomRight

            const bottomLeft = getAABBCollision({
              rectangle1: data.rectangle,
              rectangle2: splittedBounds.bottomLeft,
            })
              ? getQuadTree({
                  bounds: splittedBounds.bottomLeft,
                  rectangles: acc.bottomLeft?.data.concat(data) ?? [data],
                  treeNode: acc.bottomLeft ?? emptyQuadTree,
                  maxLevel: maxLevel - 1,
                })
              : acc.bottomLeft

            return {
              topRight,
              topLeft,
              bottomRight,
              bottomLeft,
              data: [],
            }
          }, treeNode)

          return newTree
        }
      }

      const getQuadTreeCollisions = ({ quadTree, maxLevel }) => {
        const flattenQuadTree = flatQuadTree(quadTree, maxLevel)
        const uniqueCollisions = {}
        flattenQuadTree.forEach((data) => {
          if (!Array.isArray(data)) {
            return
          }
          const entities = []
          let key = ''

          data.forEach(({ entity }) => {
            entities.push(entity)
            key = `${key},${entity}`
          })

          uniqueCollisions[key] = entities
        })

        return Object.values(uniqueCollisions)
      }

      const drawLine = ([x1, y1, x2, y2], color = 'rgb(255,0,0)') => {
        ctx.beginPath()
        ctx.moveTo(x1, canvasSize[1] - y1)
        ctx.lineTo(x2, canvasSize[1] - y2)

        ctx.strokeStyle = color
        ctx.lineWidth = 1
        ctx.stroke()
      }

      const drawRectangle = ([x1, y1, x2, y2], color = 'rgb(255,0,0)') => {
        drawLine([x1, y1, x1, y2], color)
        drawLine([x1, y2, x2, y2], color)
        drawLine([x2, y2, x2, y1], color)
        drawLine([x2, y1, x1, y1], color)
      }

      const drawQuadTree = (quadTree, bounds) => {
        let shouldSplit = false
        if (quadTree.topRight !== null) {
          shouldSplit = true
          drawQuadTree(
            quadTree.topRight,
            splitBounds({ bounds, position: 'topRight' }),
          )
        }
        if (quadTree.topLeft !== null) {
          shouldSplit = true
          drawQuadTree(
            quadTree.topLeft,
            splitBounds({ bounds, position: 'topLeft' }),
          )
        }
        if (quadTree.bottomRight !== null) {
          shouldSplit = true
          drawQuadTree(
            quadTree.bottomRight,
            splitBounds({ bounds, position: 'bottomRight' }),
          )
        }
        if (quadTree.bottomLeft !== null) {
          shouldSplit = true
          drawQuadTree(
            quadTree.bottomLeft,
            splitBounds({ bounds, position: 'bottomLeft' }),
          )
        }

        if (shouldSplit) {
          const boundHalfWidth = (bounds[2] - bounds[0]) / 2
          const boundHalfHeight = (bounds[3] - bounds[1]) / 2

          drawLine([
            bounds[0] + boundHalfWidth,
            bounds[1],
            bounds[2] - boundHalfWidth,
            bounds[3],
          ])
          drawLine([
            bounds[0],
            bounds[1] + boundHalfHeight,
            bounds[2],
            bounds[3] - boundHalfHeight,
          ])
        }
      }

      // DEMO data

      const rectangle1 = {
        entity: '1',
        rectangle: [20, 20, 60, 60],
      }
      const rectangle2 = {
        entity: '2',
        rectangle: [160, 160, 190, 190],
      }
      const rectangle3 = {
        entity: '3',
        rectangle: [250, 250, 280, 280],
      }
      const rectangle4 = {
        entity: '4',
        rectangle: [90, 90, 100, 100],
      }
      const rectangle5 = {
        entity: '5',
        rectangle: [130, 130, 140, 140],
      }
      const rectangle6 = {
        entity: '6',
        rectangle: [310, 500, 590, 590],
      }
      const rectangle7 = {
        entity: '7',
        rectangle: [305, 495, 400, 525],
      }

      const rectangles = [
        rectangle1,
        rectangle2,
        rectangle3,
        rectangle4,
        rectangle5,
        rectangle6,
        rectangle7,
      ]
      // const rectangles = [{"rectangle":[18,180,39,201],"entity":"1"},{"rectangle":[6,76,45,107],"entity":"2"},{"rectangle":[145,63,168,95],"entity":"3"},{"rectangle":[201,104,201,104],"entity":"4"},{"rectangle":[172,76,172,76],"entity":"5"},{"rectangle":[140,18,150,28],"entity":"6"},{"rectangle":[342,171,370,171],"entity":"7"},{"rectangle":[177,298,190,316],"entity":"8"},{"rectangle":[347,393,347,393],"entity":"9"},{"rectangle":[188,359,223,397],"entity":"10"},{"rectangle":[328,123,355,157],"entity":"11"},{"rectangle":[141,188,154.5,201.5],"entity":"12"},{"rectangle":[85,163,85,163],"entity":"13"},{"rectangle":[266,60,266,60],"entity":"14"},{"rectangle":[132,308,168,334],"entity":"15"},{"rectangle":[159,218,159,218],"entity":"16"},{"rectangle":[32,251,69,280],"entity":"17"},{"rectangle":[33,322,69,353],"entity":"18"},{"rectangle":[52,5,52,5],"entity":"19"},{"rectangle":[328,306,366,333],"entity":"20"},{"rectangle":[117,49,117,49],"entity":"21"},{"rectangle":[374,193,397,205],"entity":"22"},{"rectangle":[214,100,240,110],"entity":"23"},{"rectangle":[67,47,97,68],"entity":"24"},{"rectangle":[290,254,296,260],"entity":"25"},{"rectangle":[255,71,255,71],"entity":"26"},{"rectangle":[320,60,349,98],"entity":"27"},{"rectangle":[266,298,287,336],"entity":"28"},{"rectangle":[126,368,162,406],"entity":"29"},{"rectangle":[16,188,22,195],"entity":"30"},{"rectangle":[185,394,202,395],"entity":"31"},{"rectangle":[211,172,223,186],"entity":"32"},{"rectangle":[262,249,269,268],"entity":"33"},{"rectangle":[178,129,193.5,144.5],"entity":"34"},{"rectangle":[225,89,225,89],"entity":"35"},{"rectangle":[26,32,32.5,38.5],"entity":"36"},{"rectangle":[280,321,317,354],"entity":"37"},{"rectangle":[126,233,126,233],"entity":"38"},{"rectangle":[29,89,50,115],"entity":"39"},{"rectangle":[122,8,122,8],"entity":"40"},{"rectangle":[277,274,314,300],"entity":"41"},{"rectangle":[225,185,225,185],"entity":"42"},{"rectangle":[388,364,404,377],"entity":"43"},{"rectangle":[258,179,280,210],"entity":"44"},{"rectangle":[214,108,214,108],"entity":"45"},{"rectangle":[195,332,197,358],"entity":"46"},{"rectangle":[390,360,416,369],"entity":"47"},{"rectangle":[159,164,167,164],"entity":"48"},{"rectangle":[257,21,257,21],"entity":"49"},{"rectangle":[222,324,222,324],"entity":"50"},{"rectangle":[136,85,161,111],"entity":"51"},{"rectangle":[98,327,111,337],"entity":"52"},{"rectangle":[343,395,375,429],"entity":"53"},{"rectangle":[2,358,10,378],"entity":"54"},{"rectangle":[150,369,150,369],"entity":"55"},{"rectangle":[250,77,287,103],"entity":"56"},{"rectangle":[367,130,367,130],"entity":"57"},{"rectangle":[270,208,290,217],"entity":"58"},{"rectangle":[47,332,49,369],"entity":"59"},{"rectangle":[63,353,74,370],"entity":"60"},{"rectangle":[250,89,268.5,107.5],"entity":"61"},{"rectangle":[277,6,304,42],"entity":"62"},{"rectangle":[386,7,386,7],"entity":"63"},{"rectangle":[139,395,175,419],"entity":"64"},{"rectangle":[314,199,314,199],"entity":"65"},{"rectangle":[149,231,149,231],"entity":"66"},{"rectangle":[2,325,2.5,325.5],"entity":"67"},{"rectangle":[261,228,294,253],"entity":"68"},{"rectangle":[217,13,219,36],"entity":"69"},{"rectangle":[236,327,242,333],"entity":"70"},{"rectangle":[199,287,226,317],"entity":"71"},{"rectangle":[188,369,210.5,391.5],"entity":"72"},{"rectangle":[292,119,297,146],"entity":"73"},{"rectangle":[258,245,283,283],"entity":"74"},{"rectangle":[35,154,42,161],"entity":"75"},{"rectangle":[329,85,329,85],"entity":"76"},{"rectangle":[45,35,77,74],"entity":"77"},{"rectangle":[115,207,135,244],"entity":"78"},{"rectangle":[191,241,201,274],"entity":"79"},{"rectangle":[372,229,409,264],"entity":"80"},{"rectangle":[190,325,208,343],"entity":"81"},{"rectangle":[7,194,7,194],"entity":"82"},{"rectangle":[354,27,384,63],"entity":"83"},{"rectangle":[216,97,216.5,97.5],"entity":"84"},{"rectangle":[113,244,113,244],"entity":"85"},{"rectangle":[180,283,180,283],"entity":"86"},{"rectangle":[132,268,159,270],"entity":"87"},{"rectangle":[120,92,148,116],"entity":"88"},{"rectangle":[353,38,356,41],"entity":"89"},{"rectangle":[252,172,279,208],"entity":"90"},{"rectangle":[85,244,104.5,263.5],"entity":"91"},{"rectangle":[99,0,133,31],"entity":"92"},{"rectangle":[246,313,278,338],"entity":"93"},{"rectangle":[214,19,224,29],"entity":"94"},{"rectangle":[91,238,91,238],"entity":"95"},{"rectangle":[390,46,390,46],"entity":"96"},{"rectangle":[257,39,262.5,44.5],"entity":"97"},{"rectangle":[96,97,118,127],"entity":"98"},{"rectangle":[257,90,260,90],"entity":"99"},{"rectangle":[172,170,176,208],"entity":"100"}]

      const maxLevel = 4
      const timeBeforeGetQuadTree = performance.now()
      const quadTree = getQuadTree({
        bounds: [0, 0, canvasSize[0], canvasSize[1]],
        rectangles,
        maxLevel,
      })
      const timeAfterGetQuadTree = performance.now()
      console.log(
        'quadTree generation time: ',
        timeAfterGetQuadTree - timeBeforeGetQuadTree,
        'ms',
      )

      const timeBeforeGetQuadTreeCollisions = performance.now()
      const collisions = getQuadTreeCollisions({ quadTree, maxLevel })
      const timeAfterGetQuadTreeCollisions = performance.now()

      console.log(
        'getQuadTreeCollisions time: ',
        timeAfterGetQuadTreeCollisions - timeBeforeGetQuadTreeCollisions,
        'ms',
      )

      console.log('quadTree: ', quadTree)
      console.log('getQuadTreeCollisions: ', collisions)

      drawQuadTree(quadTree, [0, 0, canvasSize[0], canvasSize[1]])

      rectangles.forEach(({ rectangle }) => {
        drawRectangle(rectangle, 'rgb(0,255,0)')
      })
    </script>
  </body>
</html>
